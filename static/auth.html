<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Auth - EcomV2</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(rgba(11, 15, 20, 0.8), rgba(11, 15, 20, 0.8)), url('https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
      background-size: cover;
      background-position: center;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
    }

    .auth-card {
      background: rgba(15, 23, 34, 0.95);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .auth-logo {
      text-align: center;
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: block;
      text-decoration: none;
    }

    .auth-subtitle {
      text-align: center;
      color: var(--muted);
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 15px;
      transition: all 0.2s;
    }

    .form-input:focus {
      border-color: var(--primary);
      background: rgba(255, 255, 255, 0.1);
      outline: none;
    }

    .auth-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .auth-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .auth-switch {
      text-align: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .switch-btn {
      background: none;
      border: none;
      color: var(--primary);
      font-weight: 500;
      cursor: pointer;
      font-size: 14px;
    }

    .switch-btn:hover {
      text-decoration: underline;
    }

    .status-msg {
      margin-top: 16px;
      text-align: center;
      font-size: 14px;
      min-height: 20px;
    }
  </style>
</head>

<body>

  <div class="auth-card">
    <a href="/home" class="auth-logo">EcomV2</a>
    <p class="auth-subtitle" id="subtitle">Welcome back! Please login to continue.</p>

    <form id="loginForm" aria-label="Login form">
      <div class="form-group">
        <input id="username" class="form-input" name="username" placeholder="Username" autocomplete="username"
          required />
      </div>
      <div class="form-group">
        <input id="password" class="form-input" name="password" type="password" placeholder="Password"
          autocomplete="current-password" required />
      </div>
      <button id="loginBtn" type="submit" class="auth-btn">Login</button>
    </form>

    <form id="signupForm" aria-label="Signup form" style="display:none">
      <div class="form-group">
        <input id="su_username" class="form-input" name="username" placeholder="Username" required />
      </div>
      <div class="form-group">
        <input id="su_email" class="form-input" name="email" type="email" placeholder="Email" required />
      </div>
      <div class="form-group">
        <input id="su_password" class="form-input" name="password" type="password" placeholder="Password" required />
      </div>
      <button id="signupBtn" type="submit" class="auth-btn">Create Account</button>
    </form>

    <div class="auth-switch">
      <button id="switchBtn" class="switch-btn" type="button">Don't have an account? Sign up</button>
    </div>

    <div class="status-msg" id="status" role="status" aria-live="polite"></div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const switchBtn = document.getElementById('switchBtn');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const subtitleEl = document.getElementById('subtitle');

    function setStatus(msg) { statusEl.textContent = msg || ''; statusEl.style.color = msg.startsWith('❌') ? '#ef4444' : '#10b981'; }

    switchBtn.onclick = () => {
      const loginVisible = loginForm.style.display !== 'none';
      if (loginVisible) {
        loginForm.style.display = 'none';
        signupForm.style.display = 'block';
        subtitleEl.textContent = 'Create an account to get started.';
        switchBtn.textContent = 'Already have an account? Login';
      } else {
        loginForm.style.display = 'block';
        signupForm.style.display = 'none';
        subtitleEl.textContent = 'Welcome back! Please login to continue.';
        switchBtn.textContent = "Don't have an account? Sign up";
      }
      setStatus('');
    };

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('Logging in...');
      const body = { username: document.getElementById('username').value, password: document.getElementById('password').value };
      try {
        const resp = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const j = await resp.json();
        if (j.token) {
          setStatus('✅ Logged in successfully');
          const role = (j.user && j.user.role) || 'user';
          localStorage.setItem('token', j.token);
          if (j.user) localStorage.setItem('user', JSON.stringify(j.user));

          try {
            const SID_KEY = 'ecomv2_session_id';
            if (!sessionStorage.getItem(SID_KEY) && j.session_id) {
              sessionStorage.setItem(SID_KEY, j.session_id);
            }
          } catch (e) { }

          try {
            if (role !== 'admin') {
              const resp2 = await fetch('/api/cart', { headers: { 'Authorization': j.token } });
              if (resp2.ok) {
                const data = await resp2.json();
                const items = Array.isArray(data.items) ? data.items : [];
                localStorage.setItem('ecomv2_cart', JSON.stringify(items.map(x => ({
                  product_id: x.product_id,
                  name: x.name,
                  price: x.price,
                  image_url: x.image_url,
                  quantity: x.quantity || 1,
                }))));
              }
            }
          } catch (e) { }

          const redirectUrl = role === 'admin' ? '/dashboard-spa' : '/home';
          setTimeout(() => { window.location.href = redirectUrl; }, 600);
        } else {
          setStatus('❌ ' + (j.error || 'Login failed'));
        }
      } catch (e) { setStatus('❌ ' + e.message); }
    });

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('Creating account...');
      const body = {
        username: document.getElementById('su_username').value,
        email: document.getElementById('su_email').value,
        password: document.getElementById('su_password').value
      };
      try {
        const resp = await fetch('/api/signup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const j = await resp.json();
        if (j.user_id) {
          setStatus('✅ Account created. Please login.');
          setTimeout(() => { switchBtn.click(); }, 1000);
        } else {
          setStatus('❌ ' + (j.error || 'Signup failed'));
        }
      } catch (e) { setStatus('❌ ' + e.message); }
    });
  </script>
</body>

</html>