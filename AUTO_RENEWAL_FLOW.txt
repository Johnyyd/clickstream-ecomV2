╔════════════════════════════════════════════════════════════════════════════╗
║                    AUTO-RENEWAL API KEY - FLOW DIAGRAM                     ║
╚════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│                         SCENARIO 1: Key hết hạn                             │
└─────────────────────────────────────────────────────────────────────────────┘

    User                Analysis.py           Auto-Renewal         OpenRouter
     │                      │                      │                    │
     │  Run Analysis        │                      │                    │
     ├─────────────────────>│                      │                    │
     │                      │                      │                    │
     │                      │  Get API key from DB │                    │
     │                      ├─────────────────────>│                    │
     │                      │<─────────────────────┤                    │
     │                      │  key: sk-or-v1-xxx   │                    │
     │                      │                      │                    │
     │                      │  Call OpenRouter     │                    │
     │                      │──────────────────────┼───────────────────>│
     │                      │                      │                    │
     │                      │                      │  401 Unauthorized  │
     │                      │<─────────────────────┼────────────────────┤
     │                      │                      │                    │
     │                      │  Detect 401 error    │                    │
     │                      ├─────────────────────>│                    │
     │                      │                      │                    │
     │                      │                      │  Provision new key │
     │                      │                      ├───────────────────>│
     │                      │                      │                    │
     │                      │                      │  New key: sk-or-.. │
     │                      │                      │<───────────────────┤
     │                      │                      │                    │
     │                      │                      │  Save to DB        │
     │                      │                      ├───────────────────>│
     │                      │                      │                    │
     │                      │  New key ready       │                    │
     │                      │<─────────────────────┤                    │
     │                      │                      │                    │
     │                      │  Retry with new key  │                    │
     │                      │──────────────────────┼───────────────────>│
     │                      │                      │                    │
     │                      │                      │  200 OK + Data     │
     │                      │<─────────────────────┼────────────────────┤
     │                      │                      │                    │
     │  Analysis Result     │                      │                    │
     │  (auto_renewed=True) │                      │                    │
     │<─────────────────────┤                      │                    │
     │                      │                      │                    │


┌─────────────────────────────────────────────────────────────────────────────┐
│                    SCENARIO 2: Chưa có key (lần đầu)                        │
└─────────────────────────────────────────────────────────────────────────────┘

    User                Analysis.py           Auto-Renewal         OpenRouter
     │                      │                      │                    │
     │  Run Analysis        │                      │                    │
     ├─────────────────────>│                      │                    │
     │                      │                      │                    │
     │                      │  Get API key from DB │                    │
     │                      ├─────────────────────>│                    │
     │                      │<─────────────────────┤                    │
     │                      │  key: None           │                    │
     │                      │                      │                    │
     │                      │  Auto-provision      │                    │
     │                      ├─────────────────────>│                    │
     │                      │                      │                    │
     │                      │                      │  Provision new key │
     │                      │                      ├───────────────────>│
     │                      │                      │                    │
     │                      │                      │  New key: sk-or-.. │
     │                      │                      │<───────────────────┤
     │                      │                      │                    │
     │                      │                      │  Save to DB        │
     │                      │                      ├───────────────────>│
     │                      │                      │                    │
     │                      │  New key ready       │                    │
     │                      │<─────────────────────┤                    │
     │                      │                      │                    │
     │                      │  Call with new key   │                    │
     │                      │──────────────────────┼───────────────────>│
     │                      │                      │                    │
     │                      │                      │  200 OK + Data     │
     │                      │<─────────────────────┼────────────────────┤
     │                      │                      │                    │
     │  Analysis Result     │                      │                    │
     │  (renewed=True)      │                      │                    │
     │<─────────────────────┤                      │                    │
     │                      │                      │                    │


┌─────────────────────────────────────────────────────────────────────────────┐
│                    SCENARIO 3: Key hợp lệ (normal flow)                     │
└─────────────────────────────────────────────────────────────────────────────┘

    User                Analysis.py           Auto-Renewal         OpenRouter
     │                      │                      │                    │
     │  Run Analysis        │                      │                    │
     ├─────────────────────>│                      │                    │
     │                      │                      │                    │
     │                      │  Get API key from DB │                    │
     │                      ├─────────────────────>│                    │
     │                      │<─────────────────────┤                    │
     │                      │  key: sk-or-v1-xxx   │                    │
     │                      │                      │                    │
     │                      │  Call OpenRouter     │                    │
     │                      │──────────────────────┼───────────────────>│
     │                      │                      │                    │
     │                      │                      │  200 OK + Data     │
     │                      │<─────────────────────┼────────────────────┤
     │                      │                      │                    │
     │  Analysis Result     │                      │                    │
     │<─────────────────────┤                      │                    │
     │                      │                      │                    │


╔════════════════════════════════════════════════════════════════════════════╗
║                          ERROR HANDLING FLOW                               ║
╚════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────┐
│              SCENARIO 4: Auto-renewal thất bại (no provisioning key)        │
└─────────────────────────────────────────────────────────────────────────────┘

    User                Analysis.py           Auto-Renewal         OpenRouter
     │                      │                      │                    │
     │  Run Analysis        │                      │                    │
     ├─────────────────────>│                      │                    │
     │                      │                      │                    │
     │                      │  Get API key from DB │                    │
     │                      ├─────────────────────>│                    │
     │                      │<─────────────────────┤                    │
     │                      │  key: sk-or-v1-xxx   │                    │
     │                      │                      │                    │
     │                      │  Call OpenRouter     │                    │
     │                      │──────────────────────┼───────────────────>│
     │                      │                      │                    │
     │                      │                      │  401 Unauthorized  │
     │                      │<─────────────────────┼────────────────────┤
     │                      │                      │                    │
     │                      │  Detect 401 error    │                    │
     │                      ├─────────────────────>│                    │
     │                      │                      │                    │
     │                      │                      │  Check provisioning│
     │                      │                      │  key: NOT SET ❌   │
     │                      │                      │                    │
     │                      │  Error: No prov key  │                    │
     │                      │<─────────────────────┤                    │
     │                      │                      │                    │
     │  Error Response      │                      │                    │
     │  auto_renewal_failed │                      │                    │
     │<─────────────────────┤                      │                    │
     │                      │                      │                    │


╔════════════════════════════════════════════════════════════════════════════╗
║                            DATABASE UPDATES                                ║
╚════════════════════════════════════════════════════════════════════════════╝

BEFORE Auto-Renewal:
┌──────────────────────────────────────────────────────────────┐
│ api_keys collection                                          │
├──────────────────────────────────────────────────────────────┤
│ {                                                            │
│   "user_id": ObjectId("..."),                               │
│   "provider": "openrouter",                                 │
│   "key_encrypted": "sk-or-v1-old-expired-key",             │
│   "created_at": ISODate("2025-10-01T00:00:00Z"),           │
│   "updated_at": ISODate("2025-10-01T00:00:00Z")            │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘

AFTER Auto-Renewal:
┌──────────────────────────────────────────────────────────────┐
│ api_keys collection                                          │
├──────────────────────────────────────────────────────────────┤
│ {                                                            │
│   "user_id": ObjectId("..."),                               │
│   "provider": "openrouter",                                 │
│   "key_encrypted": "sk-or-v1-new-fresh-key",               │
│   "created_at": ISODate("2025-10-01T00:00:00Z"),           │
│   "updated_at": ISODate("2025-10-05T08:45:53Z"),  ← Updated │
│   "auto_renewed": true,                            ← New    │
│   "last_renewal_at": ISODate("2025-10-05T08:45:53Z") ← New │
│ }                                                            │
└──────────────────────────────────────────────────────────────┘


╔════════════════════════════════════════════════════════════════════════════╗
║                              KEY FEATURES                                  ║
╚════════════════════════════════════════════════════════════════════════════╝

✅ Tự động phát hiện key hết hạn (401, unauthorized, etc.)
✅ Tự động tạo runtime key mới qua Provisioning API
✅ Tự động lưu key mới vào database
✅ Tự động retry request với key mới
✅ Tự động provision key lần đầu nếu user chưa có
✅ Logging đầy đủ với masked keys (bảo mật)
✅ Error handling toàn diện
✅ Database tracking (auto_renewed, last_renewal_at)
✅ Transparent cho user - không cần thao tác thủ công

⚠️  Yêu cầu: OPENROUTER_PROVISIONING_KEY phải được set
⚠️  Yêu cầu: Có credits trong OpenRouter account
⚠️  Yêu cầu: Internet connectivity

═══════════════════════════════════════════════════════════════════════════════
